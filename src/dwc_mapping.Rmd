---
title: "Darwin Core mapping"
subtitle: "For: List of Invasive Alien Species of Union concern"
author:
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Install required libraries (only if the libraries have not been installed before):

```{r}
installed <- rownames(installed.packages())
required <- c(
  "dplyr",
  "purrr",
  "readr",
  "tidylog",
  "here",
  "ISOcodes"
)
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r message = FALSE}
library(dplyr)          # To work with data frames
library(purrr)          # To work with functions and vectors
library(readr)          # To write text files
library(tidylog)        # To provide feedback on dplyr functions
library(here)           # To find files
library(ISOcodes)       # To work with ISO 639 language codes
```

# Read source data from EASIN

The Union list is published officially on EASIN. We pull source data from the EASIN API:

```{r read_from_json}
input_data <- jsonlite::fromJSON(
  "https://easin.jrc.ec.europa.eu/apixg/catxg/euconcern",
  simplifyVector = TRUE,
  flatten = TRUE
)
input_data <- input_data$results
```

Preview data:

```{r}
input_data %>% head(n = 5)
```

# Taxon core

## Pre-processing

Create a `taxon` data frame with the taxonomic part of `input_data`:

```{r taxon_core_raw}
taxon <- input_data %>%
  select(Synonyms,
         SpeciesCatalogueId,
         SpeciesName,
         SpeciesNameAuthor,
         TaxonomyId,
         Taxonomy.Kingdom,
         Taxonomy.Phylum,
         Taxonomy.Class,
         Taxonomy.Order,
         Taxonomy.Family)
```

The column `Synonyms` contains synonym names in a nested data frame form. Example:

```{r}
taxon$Synonyms[2][[1]]
```
We flatten the synonyms and select the columns we are interested to:

```{r flatten_synonyms}
synonyms <- taxon$Synonyms %>%
  purrr::map_dfr(function(x) {
    if (length(x) > 0) {
      x %>%
        select(Name, SynonymId, SpeciesCatalogueId)
    } else NULL
  }
)
```

Preview:

```{r}
synonyms %>% head()
```

We merge `synonyms` to `taxon`, keeping their association with the original taxa (via `SpeciesCatalogueId`):

```{r flatten_synonyms}
taxon <- taxon %>%
  left_join(synonyms, by = "SpeciesCatalogueId")

accepted_taxa_with_synonyms <- taxon %>%
  filter(!is.na(Name)) %>%
  mutate(Name = NA_character_,
         SynonymId = NA_integer_) %>%
  distinct()

taxon <- taxon %>%
  bind_rows(accepted_taxa_with_synonyms) %>%
  arrange(SpeciesCatalogueId)
```

Preview:

```{r}
taxon %>% head()
```

## Term mapping

Map the data to [Darwin Core Taxon](https://rs.gbif.org/core/dwc_taxon_2022-02-02.xml):

### language

```{r language}
taxon <- taxon %>% mutate(dwc_language = "en")
```

### license

```{r license}
taxon <- taxon %>% 
  mutate(dwc_license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder

```{r rightsHolder}
taxon <- taxon %>% mutate(dwc_rightsHolder = "INBO")
```

### institutionCode

```{r institutionCode}
taxon <- taxon %>% mutate(dwc_institutionCode = "INBO")
```

### datasetID

```{r datasetID}
taxon <- taxon %>% mutate(dwc_datasetID = "")
```

### datasetName

```{r datasetName}
taxon <- taxon %>% 
  mutate(dwc_datasetName = "List of Invasive Alien Species of Union concern")
```

The following terms contain information about the taxon:

### taxonID

```{r taxonID}
taxon <- taxon %>% 
  mutate(dwc_taxonID = if_else(
    condition = is.na(SynonymId),
    true = SpeciesCatalogueId,
    false = paste(SpeciesCatalogueId, SynonymId, sep = "-")
  )
)
```

### acceptedNameUsageID

```{r acceptedNameUsageID}
taxon <- taxon %>% mutate(dwc_acceptedNameUsageID = SpeciesCatalogueId)
```

### scientificName

Notice that authorship is absent:

```{r}
all(is.na(taxon$SpeciesNameAuthor))
```

```{r scientificName}
taxon <- taxon %>% 
  mutate(dwc_scientificName = if_else(condition = is.na(SynonymId),
                                      true = SpeciesName,
                                      false = Name)
)
```

### acceptedNameUsage

```{r acceptedNameUsage}
taxon <- taxon %>% mutate(dwc_acceptedNameUsage = SpeciesName)
```

### kingdom

The higher ranks are only associate to accepted taxa. However, to avoid hemihomonymy, we add kingdom information to synonyms as well:

```{r kingdom}
taxon <- taxon %>% mutate(dwc_kingdom = Taxonomy.Kingdom)
```

### Phylum

```{r phylum}
taxon <- taxon %>% 
  mutate(dwc_phylum = if_else(condition = is.na(SynonymId),
                                       true = Taxonomy.Phylum,
                                       false = NA_character_)
)
```

### Class

```{r class}
taxon <- taxon %>% 
  mutate(dwc_class = if_else(condition = is.na(SynonymId),
                             true = Taxonomy.Class,
                             false = NA_character_)
)
```

### Order

```{r order}
taxon <- taxon %>% 
  mutate(dwc_order = if_else(condition = is.na(SynonymId),
                             true = Taxonomy.Order,
                             false = NA_character_)
)
```

### Family

```{r family}
taxon <- taxon %>% 
  mutate(dwc_family = if_else(condition = is.na(SynonymId),
                             true = Taxonomy.Family,
                             false = NA_character_)
)
```

### taxonomicStatus

```{r taxonomicStatus}
taxon <- taxon %>% 
  mutate(dwc_taxonomicStatus = if_else(condition = is.na(SynonymId),
                                       true = "accepted",
                                       false = "synonym")
)
```

## Post-processing

Only keep the Darwin Core columns:

```{r dwc_cols}
taxon <- taxon %>% select(starts_with("dwc_"))
```

Drop the `dwc_` prefix:

```{r drop_dwc}
colnames(taxon) <- gsub(pattern = "dwc_", 
                        x = colnames(taxon),
                        replacement = "")
```

Preview data:

```{r}
taxon %>% head()
```

Save to CSV:

```{r save_csv_taxon_core}
write_csv(taxon, here("data", "processed", "taxon.csv"), na = "")
```

# Map distribution extension

## Pre-processing

The column `Introductions` contains vernacular names in a nested data frame form. Example:

```{r example_introductions}
input_data$Introductions[1][[1]]
```

We flatten the introducions and select the columns we are interested to:

```{r flatten_vernacuar_names}
distribution <- input_data$Introductions %>%
  purrr::map_dfr(function(x) {
    if (length(x) > 0) {
      x 
    } else NULL
  }) %>%
  select(Year,
         Country,
         SpeciesCatalogueId,
         Reference.Name,
         Reference.Url,
         Notes)
```

Preview:

```{r}
distribution
```

## Term mapping

## Post-processing

# Map vernacular names extension

## Pre-processing

The column `CommonNames` contains vernacular names in a nested data frame form. Example:

```{r example_vernacular_names}
input_data$CommonNames[2][[1]]
```

We flatten the vernacular names and select the columns we are interested to:

```{r flatten_vernacuar_names}
vernacular <- input_data$CommonNames %>%
  purrr::map_dfr(function(x) {
    if (length(x) > 0) {
      x 
    } else NULL
  }) %>%
  select(VernacularName, 
         Language,
         SpeciesCatalogueId,
         Reference.Name,
         Reference.Url)
```

Preview:

```{r}
vernacular %>% head()
```

## Term mapping

Map the data to [Vernacular Names](http://rs.gbif.org/extension/gbif/1.0/vernacularname.xml):

### TaxonID

```{r vernacular_taxonID}
vernacular <- vernacular %>% mutate(dwc_taxonID = SpeciesCatalogueId)
```

### vernacularName

```{r vernacularName}
vernacular <- vernacular %>% mutate(dwc_vernacularName = VernacularName)
```

### source

```{r vernacular_source}
vernacular <- vernacular %>% mutate(dwc_source = case_when(
  !is.na(Reference.Name) & !is.na(Reference.Url) ~ paste(Reference.Name,
                                                         Reference.Url,
                                                         sep = " - "),
  !is.na(Reference.Name) & is.na(Reference.Url) ~ Reference.Name,
  # this doesn't occur at the moment
  is.na(Reference.Name) & !is.na(Reference.Url) ~ Reference.Url,
  .default = NA_character_
))
```

### language

Language is provided in ISO 639-3, i.e. three-letter codes:

```{r}
vernacular %>% distinct(Language)
```

We map them to ISO 639-1 (two-letter codes):

```{r map_three_to_two_letter_codes}
languages <- 
  vernacular %>% 
  distinct(Language) %>%
  filter(!is.na(Language)) %>%
  # avoid tidylog until this issue is solved:
  # https://github.com/elbersb/tidylog/issues/58
  dplyr::left_join(ISOcodes::ISO_639_2 %>%
              distinct(Alpha_3_T, Alpha_2),
            by = dplyr::join_by(Language == Alpha_3_T))
vernacular <- vernacular %>%
  left_join(languages, by = "Language") %>%
  rename(dwc_language = Alpha_2)
```

Some vernacular names have no language:

```{r no_language}
vernacular %>% filter(is.na(Language))
```

We assign language code to `en` (English):

```{r assign_en_to_na}
vernacular <- vernacular %>% 
  mutate(dwc_language = if_else(condition = is.na(Language),
                                true = "en", 
                                false = dwc_language))
```

Preview:

```{r }
vernacular %>% head()
```

## Post-processing

Only keep the Darwin Core columns:

```{r keep_dwc_vernacular}
vernacular <- vernacular %>% select(starts_with("dwc_"))
```

Drop the `dwc_` prefix:

```{r drop_dwc_vernacular}
colnames(vernacular) <- gsub(pattern = "dwc_", 
                        x = colnames(vernacular),
                        replacement = "")
```

Preview data:

```{r}
vernacular %>% head()
```

Save to CSV:

```{r save_vernacular}
write_csv(vernacular, here("data", "processed", "vernacularname.csv"), na = "")
```

# Map species profile extension

In this extension will express broad habitat characteristics (e.g. isTerrestrial) of the species.

## Pre-processing

The column `SpeciesEnvironments` contains species profile related information in a nested data frame form. Example:

```{r example_vernacular_names}
input_data$SpeciesEnvironments[1][[1]]
```

We flatten the species environment and select the columns we are interested to:

```{r flatten_species_profile}
species_profile <- input_data$SpeciesEnvironments %>%
  purrr::map_dfr(function(x) {
    if (length(x) > 0) {
      x %>%
        select(EnvironmentId,
               Environment.Description,
               SpeciesCatalogueId)
    } else NULL
  }
)
```

Preview:

```{r}
species_profile %>% head()
```

## Term mapping

Map the data to [Species Profile](http://rs.gbif.org/extension/gbif/1.0/speciesprofile.xml):

### taxonID

```{r species_profile_taxonID}
species_profile <- species_profile %>% mutate(dwc_taxonID = SpeciesCatalogueId)
```

### isMarine

```{r isMarine}
species_profile <- species_profile %>% 
  mutate(dwc_isMarine = if_else(
    condition = Environment.Description %in% c("Marine", "Estuarian"),
    true = TRUE,
    false = FALSE)
)
```

### isFreshwater

```{r isFreshwater}
species_profile <- species_profile %>% 
  mutate(dwc_isFreshwater = if_else(
    condition = Environment.Description %in% c("Fresh Water", "Estuarian"),
    true = TRUE,
    false = FALSE)
)
```

### isTerrestrial

```{r isTerrestrial}
species_profile <- species_profile %>% 
  mutate(dwc_isTerrestrial = if_else(
    condition = Environment.Description == "Terrestrial",
    true = TRUE,
    false = FALSE)
)
```

Show mapped values:

```{r show_mapping_environment}
species_profile %>%
  select(Environment.Description, 
         dwc_isMarine, 
         dwc_isFreshwater, 
         dwc_isTerrestrial) %>%
  group_by_all() %>%
  summarize(records = n())
```

## Post-processing

Only keep the Darwin Core columns:

```{r keep_dwc_species_profile}
species_profile <- species_profile %>% select(starts_with("dwc_"))
```

Drop the `dwc_` prefix:

```{r drop_dwc_species_profile}
colnames(species_profile) <- gsub(pattern = "dwc_", 
                        x = colnames(species_profile),
                        replacement = "")
```

Preview data:

```{r}
species_profile %>% head()
```

Save to CSV:

```{r save_species_profile}
write_csv(vernacular, here("data", "processed", "speciesprofile.csv"), na = "")
```
